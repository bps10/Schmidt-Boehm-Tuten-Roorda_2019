---
title: ' Spatial summation of signals from individual cones in human color vision'
author: '[Brian P. Schmidt](https://bps10.github.io), Alexandra E. Boehm, William S. Tuten, Austin Roorda'
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
  html_notebook: default
---


# Abstract

The human retina contains three classes of cone photoreceptors, which are sensitive to different portions of the visual spectrum: long (L), medium (M) and short (S) wavelengths. Neurons downstream of cones compute color information by comparing the relative activity across these three cone types. How signals from cones are integrated on small spatial scales is unknown. We used an adaptive optics microstimulator to target individual and pairs of cones with light and recorded the associated percept. Our findings demonstrate that, on a cellular scale, the visual system pools information across cones in an approximately linear fashion when generating color sensations. However, we also discovered a small, but systematic deviation from linearity when two cones of the same subclass were probed. This findings indicates the strategy for pooling information across two neurons depends on whether they come from the same or different sub-classes.

# Introduction

Motivation: How are signals from single neurons combined in the brain? Does sub-class matter or are all signals summed up? Are there any non-linearities?

Primary sensory neurons provide an organisms with real-time information about the environment. At an individual scale, the signals conveyed by sensory neurons are noisy and ambiguous. One strategy for reducing uncertainty is to pools signals across multiple detectors. Under low light conditions, for example, the visual system integrates information across cone photoreceptors. How signals from cones are pooled in daylight to produce color sensation is not known at a cellular scale.

# Experimental Methods

Two male and one female subject were enrolled in the study. Each session began by capturing a high-resolution image of the subjectâ€™s cone mosaic. From that image, three contiguous cones were selected for study (Figure 1A). During each trial of the session, the selected cones were targeted with small spots of light (543 nm; 0.35 arcmin; 500 ms) following established procedures (Harmening et al. 2014). The intensity of each spot was fixed based on threshold judgments (85% frequency of seeing) made prior to the start of the experiment. Subjects judged the hue and saturation of each trial with a scaling procedure (Schmidt et al. 2018).  Each cone and pair were tested 12 times; trials were randomly interleaved. The background in both experiments was a low photopic white (40 cd/m2). Cone mosaics were classified (L,M,S) with AOSLO densitometry in two subjects (Sabesan et al. 2015).

# Data processing

Below we will load the raw data and do some light processing: including filtering out bad trials, computing summary statistics and sanity checking. 

1. The raw trial data was read from a CSV file. The dataset contains nearly 5,000 trials completed by three subjects.

```{r results="hide", message=FALSE, echo=FALSE}
setwd("~/R/TwoConeColorSummation")
library(tidyverse)
library(car)
library(RColorBrewer)
library(ggthemes)
```

```{r, message=FALSE, echo=FALSE}
trial_data <- read_csv('all_trial_data.csv')
# The column isPair is meant to be a logical.
trial_data <- mutate(trial_data, isPair=as.logical(isPair))
summary(select(trial_data, yb, gr, delivery_error, lConeNeighbors, isPair))

```

2. Trials with delivery errors greater than 0.35 or less than 0.01 arcmin (values below 0.01 do not occur naturally) were considered bad deliveries. In those trials, we cannot be confident that the correct cone was targeted. After removing bad trials (3.6%), 4,788 trials remained for further analysis. Below, we see the distribution of delivery errors was roughly normal with a mean of 0.19 arcmin and a standard deviation of 0.036. 

```{r delivery, , fig.height=2, fig.width=4, echo=FALSE}
trial_data <- trial_data %>%
  filter(., delivery_error < 0.35) %>%
  filter(., delivery_error > 0.01)

summarize(trial_data, mean=mean(delivery_error), 
          std=sd(delivery_error), N=length(delivery_error))

ggplot(trial_data, aes(delivery_error)) + 
  geom_histogram(bins = 30)
```

3. Frequency of seeing (FoS) was computed for S- and L/M-cones and serves as a sanity check. FoS should fall close to zero when an S-cone was targeted because they are insensitive to the stimulus. When an L/M-cone was targeted FoS should have been close to 0.85 since the intensity of each flash was scaled to achieve 85% FoS via a detection task. Below we see that these expectations were approximately borne out. Trials that either targeted an S-cone or were not detected were not analyzed further. 

```{r, echo=FALSE}
Scones <- filter(trial_data, type1 == 1 | type2 == 1)
Scones <- filter(Scones, isPair == FALSE)

print(paste(c('S-cone FoS: ', 
              round(sum(!is.na(Scones$yb)) / length(Scones$delivery_error) * 100, 1)), 
            collapse = ' '))
print(paste(c('L/M-cone FoS: ', 
              round(sum(!is.na(trial_data$yb)) / length(trial_data$delivery_error) * 100, 1)), 
            collapse = ' '))

# Now filter out bad trials
trial_data <- filter(trial_data, type1 != 1 & type2 != 1)
trial_data <- filter(trial_data, !is.na(yb))
```

4. The remaining dataset contained trials in which individual or pairs of L- and M-cones were stimulated (N=4,087). For some analyses, we wanted to know both the type tested and whether it was a pair or a single cone. To facilitate these analyses, a type ID was created in which  unknown-cone = 0, unknown-pair=1, 1M=2, 1L=3, 2M=4, L+M=5 and 2L=6. Note: S-cones were already removed from the data and the mosaic of subject 20075 has not been classified.

```{r, echo=FALSE}
trial_data <- trial_data %>%
  mutate(., typeID=if_else(isPair, type1 + type2, type1)) %>%
  mutate(., typeID=if_else(typeID == 0, 
                           if_else(isPair, as.integer(1), as.integer(0)), as.integer(typeID))) %>%
  mutate(., typeIDstr=factor(typeID, labels = 
                               c('unknown-cone', 'unknown-pair', 'M-cone', 
                                 'L-cone', 'M+M-pair', 'L+M-pair', 'L+L-pair')))
tally(trial_data)
```

5. Finally, saturation was computed from a sum of the absolute values of the green-red (gr) and yellow-blue (yb) dimensions ($\mid yb \mid + \mid gr \mid$). Below we see a plot of saturation as a function of type ID. Saturation was similar across all cone types, with exception of the unidentified cones in S20075. This subject reported more saturated sensations than the other two subjects.

```{r, echo=FALSE, fig.height=3, fig.width=9, message=FALSE}
trial_data <- mutate(trial_data, saturation = abs(yb) + abs(gr))

ggplot(trial_data, aes(x=saturation)) + 
  geom_histogram(binwidth=0.1) + facet_grid(. ~ typeIDstr)
```

# Results

## Variability in sensations from cones with the same sensitivity

We first grouped each trial based on the subject and sub-type of cone or pair probed. We then found them mean, standard deviation and count for each group. The results are reported in a table below. In both subjects with classified cones, individual and pairs of M-cones produced gr means that were greater than zero, while L-cone conditions led to negative values. This observation is consistent with a predictive relationship between cone type and color report, as found previously (Sabesan et al. 2016; Schmidt et al. 2018).

```{r, echo=FALSE, , fig.height=5, fig.width=5, message=FALSE}
(typeGroup <- trial_data %>%
  #filter(., subject != '20075L') %>%
  group_by(., typeIDstr, isPair) %>% 
  summarise(., yb_mean=signif(mean(yb), 3), 
            yb_sem=signif(sd(yb) / sqrt(length(yb)), 3), 
            gr_mean=signif(mean(gr), 3), 
            gr_sem=signif(sd(gr) / sqrt(length(gr)), 3), N=length(gr))
)

ggplot(data=typeGroup, aes(x=yb_mean, y=gr_mean, color=typeIDstr, shape=isPair)) +
  geom_point(size=3) + 
  geom_errorbar(aes(x=yb_mean, ymin=gr_mean - gr_sem, ymax=gr_mean + gr_sem)) +
  geom_errorbarh(aes(y=gr_mean, xmin=yb_mean - yb_sem, xmax=yb_mean + yb_sem, height=0.01)) + 
  coord_equal(xlim=c(-0.25, 0.25), ylim=c(-0.25, 0.25)) +
  xlab('(yellow - blue) / total') + 
  ylab('(green - red) / total') +
  scale_color_manual(
    values = c("black", "black", "#3aaf4f", "#d1463e", "#3aaf4f", "#AAAA00", "#d1463e"), 
    name="spectral type",
    labels = c("unknown-cone", "unknown-pair", "M-cone", "L-cone", "M+M-pair", "L+M-pair", "L+L-pair")) +
  theme_bw(base_size=15)
ggsave("lms_UAD_means.pdf")

```

Next, data was further grouped by the cone or pair targeted (masterID). The mean of each location is represented below.

```{r, echo=FALSE, fig.height=3, fig.width=8, message=FALSE}
singleAndPairs <- trial_data %>%
  select(., -typeIDstr) %>%
  group_by(., subject, masterID1, masterID2) %>% 
  summarise_all(., mean)

boundary <- data.frame(x=c(-1, 0, 1, 0, -1), y=c(0, 1, 0, -1, 0))

ggplot(data=singleAndPairs, aes(x=yb, y=gr, color=as.factor(typeID))) + 
  geom_point(alpha=0.6, size=0.4) +
  facet_grid(. ~ subject) +
  geom_rug(alpha=0.4) + 
  coord_equal(xlim=c(-1, 1), ylim=c(-1, 1)) + 
  xlab('(yellow - blue) / total') + ylab('(green - red) / total') + 
  scale_color_manual(
    values = c("black", "black", "#3aaf4f", "#d1463e", "#3aaf4f", "#AAAA00", "#d1463e"), 
    name="spectral type",
    labels = c("unknown-cone", "unknown-pair", "M-cone", "L-cone", "M+M-pair", "L+M-pair", "L+L-pair")) +
  #scale_color_brewer(palette = "Spectral") +
  geom_path(data = boundary, aes(x=x, y=y), colour='gray', linetype=2) +
  theme_bw()

ggsave("lms_UAD.pdf")
```

These plots illustrate the spread of responses collected from each cone or pair tested in each subject. There are a few features to note. Firstly, there were individual differences in color responses. S20075 used blue more frequently than the two other subjects and S10001 did not report yellow on any trials. However, the general patterns are similar. Most of the variance was found along the green-red dimension and there were few points that fell in the blueish-red or greenish-yellow quadrants These patterns are similar to previous reports (Schmidt et al. 2018). In the two subjects with classified mosaics, we additionally see that L-cone targeted trials tended to fall along the red region of this space, while M-cones were more likely to fall on the green side of the y-axis.

## Mosaic parameters do not predict responses

Also similar to previous findings, color reports varied even between cones with the same photopigment (Schmidt et al. 2018). Some L-cones, for instance, elicited highly saturated red sensations, while a majority produce white or desaturated pink reports. We next asked whether the variability in sensations between cones with the same sensitivity could be explained by low level features of the mosaic. Specifically, can we predict whether an L-cone will produce a saturated red or a desaturated pink based on the surrounding cone types or the delivery error? And in the case of cone pairs, did the distance between the two cones influence color appearance? To answer these question, we grouped responses according to the number of cones targeted (one or two), the session in which trial occurred and the specific cone(s) that was targeted. The mean and count was then computed for each cone(s). Only those cones pairs which had at least four good trials were analyzed.

```{r, echo=FALSE}
singleConesSummary <- trial_data %>% 
  select(., -typeIDstr) %>%
  filter(., isPair==FALSE) %>% 
  group_by(., subject, session, masterID1) %>%   
  summarise_all(., c("mean", "length")) %>%
  filter(., yb_length > 3) %>%
  select(., -contains("_length")) %>%
  rename_(.dots=setNames(names(.), gsub("_mean", "", names(.))))

twoConesSummary <- trial_data %>%   
  select(., -typeIDstr) %>%
  filter(., isPair==TRUE) %>% 
  group_by(., subject, session, masterID1, masterID2) %>%
  summarise_all(., c("mean", "length")) %>%
  filter(., yb_length > 3) %>%
  select(., -contains("_length")) %>%
  rename_(.dots=setNames(names(.), gsub("_mean", "", names(.))))
```

Below is a matrix of correlation plots for the single cone condition.

```{r, fig.height=7, fig.width=7, echo=FALSE, message=FALSE}
# scatterplotMatrix with car package
scatterplotMatrix(singleConesSummary[ ,c("yb", "gr", "saturation", 
                                         "lConeNeighbors")],
                  diagonal=list(method ="histogram"),
                  ellipse=FALSE)
```

Two cone condition:

```{r, fig.height=7, fig.width=7, echo=FALSE, message=FALSE}

scatterplotMatrix(twoConesSummary[ ,c("yb", "gr", "saturation", 
                                      "lConeNeighbors",
                                      "distance_btwn_cones_pix")],
                  diagonal=list(method ="histogram"),
                  ellipse=FALSE)
```

None of the above correlations were statistically significant with the exception of the relationship between gr and yb. The local neighborhood surrounding a cone is typically thought to be an important factor in generating color sensations. However, we did not find a statistical relationship. The distance between cones may also be an important factor influencing appearance. Neither color nor saturation judgments were correlated with the distance between targeted cones (plotted here in pixels). Cone pairs were never separated by more than one cone, which may explain why we did not detect a relationship. Moreover, the subjects verbally reported that the flashes always appeared as a single uniformly colored dot. Over these very small spatial distances, the visual system appears to be yoking neuronal activities together. In the future, systematically varying the distance between stimulated pairs will be an informative exercise. At a certain critical distance, the points of light will be seen as two spatially distinct dots. It is less clear at what distance the points will be perceived as two distinct colors.

## Two cone responses are an average of individual reports

While features of the mosaic and physical stimulus did not predict color reports, we hypothesized that the sensations recorded from individual cones would be predictive of paired stimulation conditions. To address this question, we matched the mean response from each cone pairs with the the mean report from each cone tested individually.

```{r, warning=FALSE, echo=FALSE, message=FALSE}

singleConesSummary <- trial_data %>%
  select(., -typeIDstr) %>%
  filter(., isPair==FALSE) %>% 
  group_by(., subject, session, masterID1) %>%   
  summarise_all(., c("mean", "length")) %>%
  filter(., yb_length > 3) %>%
  select(., -contains("_length")) %>%
  rename_(.dots=setNames(names(.), gsub("_mean", "", names(.))))

twoConesSummary <- trial_data %>%
  select(., -typeIDstr) %>%
  filter(., isPair==TRUE) %>% 
  group_by(., subject, session, masterID1, masterID2) %>%
  summarise_all(., c("mean", "length")) %>%
  filter(., yb_length > 3) %>%
  select(., -contains("_length")) %>%
  rename_(.dots=setNames(names(.), gsub("_mean", "", names(.))))

merged1 <- merge(twoConesSummary, 
           select(singleConesSummary, subject, 
                  session, masterID1, yb, gr, lConeNeighbors), 
           by=c("subject", "session", "masterID1")) %>% 
  rename(., yb12=yb.x, gr12=gr.x, yb1=yb.y, gr1=gr.y,
                  lConeNeighbors12=lConeNeighbors.x, 
                  lConeNeighbors1=lConeNeighbors.y)

sessionMerge <- merged1 %>% 
  merge(., select(singleConesSummary, subject, session,
                  masterID1, yb, gr, lConeNeighbors), 
        by.x=c("subject", "session", "masterID2"),
        by.y=c("subject", "session", "masterID1")) %>% 
  rename(., yb2=yb, gr2=gr, lConeNeighbors2=lConeNeighbors) %>%
  mutate(., saturation12=abs(yb12) + abs(gr12),
         saturation1=abs(yb1) + abs(gr1),
         saturation2=abs(yb2) + abs(gr2))
```

We then fit a linear model to the data. Behavioral reports from two cone stimulation were predicted by an average of the individual responses: $gr_{12} = (gr_1 + gr_2) / 2$. Below is a visualization of the measured responses against the predictions.

```{r, fig.height=3.5, fig.width=5.5, echo=FALSE, message=FALSE}
unity = data.frame(x=c(-1, 1), y=c(-1, 1))
ggplot(data=sessionMerge, aes(x=(gr1 + gr2) / 2, y=gr12)) + 
  geom_point() +
  geom_smooth(method=lm) +
  coord_equal(xlim=c(-1, 1), ylim=c(-1, 1)) +
  geom_path(data=unity, aes(x=x, y=y), colour='gray', linetype=1) +
  ggtitle('green - red / total') +
  geom_path(data=unity, aes(x=x, y=y), colour='gray', linetype=1) +
  xlab('average of individual responses') + ylab('observed pair response') + 
  theme_classic(base_size=15)

ggsave("prediction_gr.pdf")

unity = data.frame(x=c(-1, 1), y=c(-1, 1))
ggplot(data=sessionMerge, aes(x=(yb1 + yb2) / 2, y=yb12)) + 
  geom_point() +
  geom_smooth(method=lm) +
  coord_equal(xlim=c(-1, 1), ylim=c(-1, 1)) +
  geom_path(data=unity, aes(x=x, y=y), colour='gray', linetype=1) +
  ggtitle('yellow - blue / total') +
  geom_path(data=unity, aes(x=x, y=y), colour='gray', linetype=1) +
  xlab('average of individual responses') + ylab('observed pair response') + 
  theme_classic(base_size=15)

ggsave("prediction_yb.pdf")

```

Results of linear regression (gr dimension followed by yb):
```{r, echo=FALSE}
# A linear model predicts the results based on an average of the individual responses.
mod <- lm((gr1 + gr2) / 2 ~ gr12, sessionMerge)
summary.lm(mod)


mod <- lm((yb1 + yb2) / 2 ~ yb12, sessionMerge)
summary.lm(mod)
```


## Pairs with the same type are more saturated than predicted by average

A simple linear model captured a large fraction of the variance (>72%). However, there were some pairs that deviated substantially from the best fit line. We wondered whether the deviation from linearity might be predicted by the sub-class of the two cones. For instance, do an L- and M-cone interact in a non-linear manner, while two L or two M-cones sum linearly?

```{r, echo=FALSE}
# Add a column w difference from prediction
sessionMerge <- mutate(sessionMerge, 
                       diff_from_prediction=saturation12 - 
                         ((saturation1 + saturation2) / 2))

```

We found the saturation for each pair and subtracted it from the average of the two cones probed alone. Those results are plotted below. A unity line represents the condition where the observed saturation judgment was predicted exactly by the average of individual responses. Notice that the L+L and M+M pairs tend to fall above the unity line -- particularly at higher saturation values. In contrast, the L+M pairs fall below the line. These observations indicate that the cones with the same spectral type produced slightly more saturated reports than predicted by the average of their individual responses.

```{r, fig.height=3, fig.width=5, echo=FALSE, message=FALSE}
ggplot(data=filter(sessionMerge, typeID > 3), 
       aes(x=(saturation1 + saturation2) / 2, y=saturation12, color=as.factor(typeID))) + 
  geom_point() + 
  coord_equal(xlim=c(0, 1), ylim=c(0, 1)) +
  scale_color_manual(values = c("green", "yellow", "red"), name="spectral type",
                     labels = c("M+M", "L+M", "L+L")) +
  geom_path(data=unity, aes(x=x, y=y), colour='gray', linetype=1) + 
  xlab('predicted saturation') +
  ylab('measured saturation') +
  theme_classic(base_size=15)

ggsave('observed-predicted_scatter.pdf')

```

We quantified this trend directly by taking the difference between the observed and predicted saturation judgments. The results are illustrated in a histogram below. Student's t-test's confirm that the L+M pairs were significantly less saturated (more white) than a simple average of their individual responses, while the opposite was true for cones with the same spectral type.

```{r, fig.height=3, fig.width=5, echo=FALSE, message=FALSE}
ggplot(data=filter(sessionMerge, typeID > 3), 
       aes(x=saturation12 - ((saturation1 + saturation2) / 2), 
           color=as.factor(typeID))) + 
  geom_freqpoly(binwidth=0.1) +
  scale_color_manual(
    values = c("green", "yellow", "red"), 
    name="spectral type",
    labels = c("M+M", "L+M", "L+L")) + 
  xlab("observed - predicted saturation") +
  theme_classic(base_size=15)

ggsave('observed-predicted_histogram.pdf')

```

L+M pairs have a mean that is significantly different from zero.

```{r, echo=FALSE}

t.test(sessionMerge %>% 
         filter(., typeID == 5) %>% 
         select(., diff_from_prediction)
       )
```

L+L and M+M pairs have a mean that is significantly different from zero, but in the opposite direction.

```{r, echo=FALSE}
t.test(sessionMerge %>% 
         filter(., typeID == 4 | typeID == 6) %>%
         select(., diff_from_prediction)
       )
```

Finally, L+M pairs are significantly different from the population of responses collected from L+L and M+M pairs.
```{r, echo=FALSE}
t.test(sessionMerge %>% 
         filter(., typeID == 5) %>% 
         select(., diff_from_prediction),
       sessionMerge %>% 
         filter(., typeID == 4 | typeID == 6) %>%
         select(., diff_from_prediction)
       )
```

# Conclusions

Color sensations from pairs of cones were predicted by a simple average of individual responses. However, when two cones from the same subclass were probed, there was a systematic deviation from a simple average. These pairs produced significantly more saturated colors than predicted by an average of the colors elicited when probed alone. This observation suggests that the visual system uses a different strategy when combining information within versus across neuronal sub-classes.

